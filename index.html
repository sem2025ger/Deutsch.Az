import React, { useState, useRef, useEffect } from 'react';
import { 
  Upload, FileText, Loader2, Copy, Check, AlertCircle, 
  Play, Globe, Languages, ArrowRight, Download, Volume2, 
  Mic, Maximize, Minimize 
} from 'lucide-react';

const App = () => {
  const [file, setFile] = useState(null);
  const [videoPreview, setVideoPreview] = useState(null);
  const [status, setStatus] = useState('idle'); // idle, processing, success, error
  const [result, setResult] = useState('');
  const [translation, setTranslation] = useState('');
  const [targetLang, setTargetLang] = useState('ru');
  const [isTranslating, setIsTranslating] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const [copied, setCopied] = useState(false);
  const [progress, setProgress] = useState(0);
  const [selectedVoice, setSelectedVoice] = useState('Kore');
  
  // Fullscreen State
  const [isFullscreen, setIsFullscreen] = useState(false);
  const appRef = useRef(null);

  const apiKey = ""; // API key is handled by the environment

  const languages = [
    { code: 'ru', name: 'Русский' },
    { code: 'en', name: 'English' },
    { code: 'az', name: 'Azərbaycan' }
  ];

  const voices = [
    { id: 'Kore', name: 'Kore (Женский, теплый)' },
    { id: 'Zephyr', name: 'Zephyr (Мужской, энергичный)' },
    { id: 'Charon', name: 'Charon (Мужской, глубокий)' },
    { id: 'Leda', name: 'Leda (Женский, спокойный)' },
    { id: 'Puck', name: 'Puck (Игривый)' }
  ];

  // Fullscreen Logic with Fallback for Iframe restrictions
  useEffect(() => {
    const handleFullscreenChange = () => {
      const isNativeFull = !!(document.fullscreenElement || document.webkitFullscreenElement);
      // We only force state if it was a native exit (e.g. via ESC)
      if (!isNativeFull && isFullscreen && (document.fullscreenEnabled || document.webkitFullscreenEnabled)) {
        setIsFullscreen(false);
      }
    };

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

    return () => {
      document.removeEventListener('fullscreenchange', handleFullscreenChange);
      document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
    };
  }, [isFullscreen]);

  const toggleFullscreen = () => {
    if (!appRef.current) return;

    if (!isFullscreen) {
      const elem = appRef.current;
      const requestMethod = elem.requestFullscreen || elem.webkitRequestFullscreen;
      
      if (requestMethod) {
        requestMethod.call(elem).then(() => {
          setIsFullscreen(true);
        }).catch(err => {
          // If Disallowed by permissions policy (common in iframes)
          // we fallback to "Simulated Fullscreen" using CSS
          console.warn("Native Fullscreen API blocked by policy, using CSS fallback.");
          setIsFullscreen(true);
        });
      } else {
        // Fallback for older browsers
        setIsFullscreen(true);
      }
    } else {
      const exitMethod = document.exitFullscreen || document.webkitExitFullscreen;
      if (exitMethod && (document.fullscreenElement || document.webkitFullscreenElement)) {
        exitMethod.call(document).catch(() => {});
      }
      setIsFullscreen(false);
    }
  };

  // PCM to WAV conversion utility
  const pcmToWav = (pcmData, sampleRate = 24000) => {
    const buffer = new ArrayBuffer(44 + pcmData.length * 2);
    const view = new DataView(buffer);

    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    };

    writeString(0, 'RIFF');
    view.setUint32(4, 32 + pcmData.length * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, pcmData.length * 2, true);

    for (let i = 0; i < pcmData.length; i++) {
      view.setInt16(44 + i * 2, pcmData[i], true);
    }

    return new Blob([buffer], { type: 'audio/wav' });
  };

  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const base64String = reader.result.split(',')[1];
        resolve(base64String);
      };
      reader.onerror = (error) => reject(error);
    });
  };

  const fetchWithRetry = async (url, options, maxRetries = 5) => {
    for (let i = 0; i <= maxRetries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.ok) return await response.json();
        if (i === maxRetries) throw new Error(`Ошибка сервера: ${response.status}`);
      } catch (err) {
        if (i === maxRetries) throw err;
        const delay = Math.pow(2, i) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  };

  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    if (selectedFile && selectedFile.type.startsWith('video/')) {
      setFile(selectedFile);
      setVideoPreview(URL.createObjectURL(selectedFile));
      setStatus('idle');
      setResult('');
      setTranslation('');
      setErrorMessage('');
    } else {
      setErrorMessage('Пожалуйста, выберите корректный видеофайл');
    }
  };

  const downloadVideo = () => {
    if (!file) return;
    const url = URL.createObjectURL(file);
    const a = document.createElement('a');
    a.href = url;
    a.download = file.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const processVideo = async () => {
    if (!file) return;
    setStatus('processing');
    setErrorMessage('');
    setResult('');
    setTranslation('');
    setProgress(10);

    try {
      const base64Data = await fileToBase64(file);
      setProgress(30);
      const prompt = "Please transcribe the entire speech in this video. The video is in German. Split the text into logical sentences or short segments and number them (e.g., 1. [Text], 2. [Text]). Output only the numbered transcription text in German.";
      
      const payload = {
        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }]
      };

      setProgress(50);
      const resultData = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
      );

      const extractedText = resultData.candidates?.[0]?.content?.parts?.[0]?.text;
      if (extractedText) {
        setResult(extractedText);
        setStatus('success');
      } else {
        throw new Error("Не удалось извлечь текст.");
      }
      setProgress(100);
    } catch (err) {
      setStatus('error');
      setErrorMessage(err.message || "Ошибка при обработке.");
    }
  };

  const translateText = async () => {
    if (!result) return;
    setIsTranslating(true);
    const langName = languages.find(l => l.code === targetLang)?.name;
    try {
      const prompt = `Translate the following numbered German transcription into ${langName}. Maintain the exact same numbering. Output only the translated numbered text:\n\n${result}`;
      const payload = { contents: [{ parts: [{ text: prompt }] }] };
      const resultData = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
      );
      const translated = resultData.candidates?.[0]?.content?.parts?.[0]?.text;
      if (translated) setTranslation(translated);
    } catch (err) {
      setErrorMessage("Ошибка при переводе.");
    } finally {
      setIsTranslating(false);
    }
  };

  const playTTS = async () => {
    if (!translation) return;
    setIsSpeaking(true);
    try {
      const cleanText = translation.replace(/^\d+\.\s*/gm, ''); 
      const payload = {
        contents: [{ parts: [{ text: cleanText }] }],
        generationConfig: {
          responseModalities: ["AUDIO"],
          speechConfig: {
            voiceConfig: {
              prebuiltVoiceConfig: {
                voiceName: selectedVoice
              }
            }
          }
        },
        model: "gemini-2.5-flash-preview-tts"
      };

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
      );
      
      const data = await response.json();
      const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      
      if (base64Audio) {
        const binaryString = atob(base64Audio);
        const pcmData = new Int16Array(binaryString.length / 2);
        for (let i = 0; i < pcmData.length; i++) {
          pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
        }
        
        const wavBlob = pcmToWav(pcmData);
        const audioUrl = URL.createObjectURL(wavBlob);
        const audio = new Audio(audioUrl);
        audio.onended = () => setIsSpeaking(false);
        audio.play();
      } else {
        throw new Error("Аудио не получено");
      }
    } catch (err) {
      console.error(err);
      setErrorMessage("Не удалось озвучить текст.");
      setIsSpeaking(false);
    }
  };

  const copyToClipboard = (text) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {}
    document.body.removeChild(textArea);
  };

  return (
    <div 
      ref={appRef}
      className={`min-h-screen transition-all duration-300 font-sans text-slate-900 ${
        isFullscreen 
          ? 'fixed inset-0 z-[9999] bg-white w-full h-full overflow-hidden' 
          : 'bg-slate-50 p-4 md:p-8'
      }`}
    >
      <div className={`mx-auto flex flex-col ${isFullscreen ? 'w-full h-full p-6' : 'max-w-5xl h-auto'}`}>
        <header className={`relative text-center ${isFullscreen ? 'mb-4 shrink-0' : 'mb-8'}`}>
          {/* Fullscreen Toggle Button */}
          <div className="absolute right-0 top-0">
             <button 
              onClick={toggleFullscreen}
              className="flex items-center space-x-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 shadow-sm transition-all active:scale-95 text-sm font-medium"
             >
                {isFullscreen ? (
                  <><Minimize className="w-4 h-4" /> <span>⤫ Выйти</span></>
                ) : (
                  <><Maximize className="w-4 h-4" /> <span>⛶ Полный экран</span></>
                )}
             </button>
          </div>

          <div className={`inline-flex items-center justify-center p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 ${isFullscreen ? 'mb-2 p-2' : 'mb-4'}`}>
            <Mic className={`${isFullscreen ? 'w-6 h-6' : 'w-8 h-8'} text-white`} />
          </div>
          <h1 className={`${isFullscreen ? 'text-xl' : 'text-3xl'} font-bold text-slate-800`}>Транскрибация и Озвучка</h1>
          {!isFullscreen && <p className="text-slate-500 mt-2 italic">Интеллектуальный перевод с немецкого с живыми голосами</p>}
        </header>

        <div className={`grid grid-cols-1 lg:grid-cols-12 gap-6 ${isFullscreen ? 'flex-1 min-h-0' : ''}`}>
          {/* Left Column: Upload (4 cols) */}
          <div className={`lg:col-span-4 space-y-4 ${isFullscreen ? 'h-full flex flex-col' : ''}`}>
            <div className={`border-2 border-dashed rounded-2xl p-6 transition-all bg-white shadow-sm flex flex-col justify-center ${file ? 'border-indigo-400' : 'border-slate-200 hover:border-indigo-300'} ${isFullscreen ? 'flex-1' : ''}`}>
              {!file ? (
                <label className="flex flex-col items-center cursor-pointer py-10">
                  <Upload className="w-10 h-10 text-slate-300 mb-4" />
                  <span className="text-sm font-medium text-slate-600">Выберите видео</span>
                  <input type="file" className="hidden" accept="video/*" onChange={handleFileChange} />
                </label>
              ) : (
                <div className="space-y-4 h-full flex flex-col">
                  <div className="flex items-center justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Файл выбран</p>
                    <div className="flex items-center space-x-3">
                      <button onClick={downloadVideo} className="flex items-center text-xs text-indigo-600 font-medium">
                        <Download className="w-3.5 h-3.5 mr-1" /> Скачать
                      </button>
                      <button onClick={() => {setFile(null); setVideoPreview(null); setStatus('idle'); setTranslation(''); setResult('');}} className="text-xs text-red-500 hover:underline">
                        Сбросить
                      </button>
                    </div>
                  </div>
                  {videoPreview && <video src={videoPreview} controls className="w-full rounded-xl border border-slate-100 shadow-inner bg-black aspect-video flex-shrink-0" />}
                  <button onClick={processVideo} disabled={status === 'processing'} className={`w-full py-3 rounded-xl font-bold text-white transition-all shadow-md ${status === 'processing' ? 'bg-slate-400' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                    {status === 'processing' ? <span className="flex items-center justify-center"><Loader2 className="w-4 h-4 animate-spin mr-2" /> {progress}%</span> : 'Начать анализ'}
                  </button>
                </div>
              )}
            </div>
            {errorMessage && <div className="flex items-start p-4 bg-red-50 border border-red-100 rounded-xl text-red-600"><AlertCircle className="w-5 h-5 mr-3 mt-0.5 shrink-0" /><p className="text-xs">{errorMessage}</p></div>}
          </div>

          {/* Right Column: Results (8 cols) */}
          <div className={`lg:col-span-8 space-y-6 ${isFullscreen ? 'h-full flex flex-col min-h-0' : ''}`}>
            <div className={`grid grid-cols-1 md:grid-cols-2 gap-6 ${isFullscreen ? 'flex-1 min-h-0' : ''}`}>
              
              {/* Transcription Box */}
              <div className="bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col overflow-hidden h-[500px] md:h-full">
                <div className="px-5 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                  <div className="flex items-center space-x-2"><span className="w-2 h-2 rounded-full bg-amber-400"></span><h2 className="text-sm font-bold text-slate-600 uppercase tracking-tight">Оригинал (DE)</h2></div>
                  {result && <button onClick={() => copyToClipboard(result)} className="p-1.5 hover:bg-slate-200 rounded-lg transition-colors">{copied ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4 text-slate-400" />}</button>}
                </div>
                <div className="flex-1 p-5 overflow-y-auto bg-white">
                  {!result && status !== 'processing' && <div className="h-full flex flex-col items-center justify-center text-slate-300"><FileText className="w-12 h-12 mb-2 opacity-10" /><p className="text-xs">Ожидание транскрибации...</p></div>}
                  {status === 'processing' && <div className="h-full flex flex-col items-center justify-center"><Loader2 className="w-8 h-8 text-indigo-200 animate-spin mb-2" /><p className="text-xs text-slate-400">Распознавание речи...</p></div>}
                  {result && <div className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed space-y-2">{result.split('\n').map((line, idx) => <p key={idx} className={line.trim().match(/^\d+\./) ? "pb-2 border-b border-slate-50 last:border-0" : ""}>{line}</p>)}</div>}
                </div>
              </div>

              {/* Translation Box */}
              <div className="bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col overflow-hidden h-[500px] md:h-full">
                <div className="px-5 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                  <div className="flex items-center space-x-2"><span className="w-2 h-2 rounded-full bg-emerald-400"></span><h2 className="text-sm font-bold text-slate-600 uppercase tracking-tight">Перевод</h2></div>
                  <div className="flex items-center space-x-2">
                    <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)} className="text-xs bg-white border border-slate-200 rounded px-1 py-0.5 focus:ring-1 focus:ring-indigo-500">
                      {languages.map(lang => <option key={lang.code} value={lang.code}>{lang.name}</option>)}
                    </select>
                  </div>
                </div>
                
                <div className="flex-1 p-5 overflow-y-auto relative bg-white">
                  {!result && <div className="h-full flex flex-col items-center justify-center text-slate-300 text-xs text-center px-4">Сначала извлеките текст</div>}
                  {result && !translation && !isTranslating && <div className="h-full flex flex-col items-center justify-center space-y-4"><div className="p-4 bg-indigo-50 rounded-full"><ArrowRight className="w-6 h-6 text-indigo-400" /></div><button onClick={translateText} className="text-sm font-bold text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100 shadow-sm transition-all">Перевести на {languages.find(l => l.code === targetLang)?.name}</button></div>}
                  {isTranslating && <div className="h-full flex flex-col items-center justify-center"><Loader2 className="w-8 h-8 text-emerald-300 animate-spin mb-2" /><p className="text-xs text-slate-400">Переводим...</p></div>}
                  {translation && <div className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed space-y-2">{translation.split('\n').map((line, idx) => <p key={idx} className={line.trim().match(/^\d+\./) ? "pb-2 border-b border-slate-50 last:border-0" : ""}>{line}</p>)}</div>}
                </div>

                {translation && (
                  <div className="px-5 py-4 border-t border-slate-100 bg-slate-50/50 space-y-3 shrink-0">
                    <div className="flex items-center justify-between">
                      <select value={selectedVoice} onChange={(e) => setSelectedVoice(e.target.value)} className="text-[10px] font-bold uppercase tracking-wider bg-white border border-slate-200 rounded px-2 py-1 outline-none">
                        {voices.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                      </select>
                      <button onClick={playTTS} disabled={isSpeaking} className={`flex items-center space-x-2 px-4 py-2 rounded-full text-white font-bold text-xs transition-all ${isSpeaking ? 'bg-slate-300 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600 shadow-sm active:scale-95'}`}>
                        {isSpeaking ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Volume2 className="w-3.5 h-3.5" />}
                        <span>{isSpeaking ? 'Говорит...' : 'Озвучить'}</span>
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
        
        {!isFullscreen && (
          <footer className="mt-12 text-center text-slate-400 text-[10px] font-medium uppercase tracking-[0.2em] shrink-0">
            Powered by Gemini 2.5 Flash • Multilingual Audio Intelligence • Living Voices Enabled
          </footer>
        )}
      </div>
    </div>
  );
};

export default App;
